<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Web App</title>
    <style>
        body { font-family: sans-serif; display: flex; flex-direction: column; align-items: center; }
        #webcam-container { margin-top: 10px; border: 2px solid #ccc; }
        #label-container { margin-top: 10px; font-size: 1.2em; font-weight: bold; }
        button { font-size: 1em; padding: 10px 15px; margin: 10px; }
    </style>
</head>
<body>
    <h1>My AI Web App</h1>
    <button type="button" onclick="init()">Start Camera</button>
    <div id="webcam-container"></div>
    <div id="label-container"></div>

    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@1.3.1/dist/tf.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@teachablemachine/image@0.8/dist/teachablemachine-image.min.js"></script>

    <script type="text/javascript">
        // -----------------------------------------------------------------
        // üìå 1. ‡∏•‡∏¥‡∏á‡∏Å‡πå‡πÇ‡∏°‡πÄ‡∏î‡∏• AI ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì (‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á)
        // -----------------------------------------------------------------
        const URL = "https://teachablemachine.withgoogle.com/models/dMIik5uqa/";

        // -----------------------------------------------------------------
        // üìå 2. ‡∏•‡∏¥‡∏á‡∏Å‡πå GOOGLE APPS SCRIPT "‡πÉ‡∏´‡∏°‡πà" ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì (‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á)
        // -----------------------------------------------------------------
        const APPS_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbwQglYwHrPrPraYrjCv5q5iUazrpWGV6_BPyCwcn8vDrvXJbBx022I6Mm5FkD8gfx_mVQ/exec";
        
        // -----------------------------------------------------------------
        // üìå 3. ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å (‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á)
        // -----------------------------------------------------------------
        const CONFIDENCE_THRESHOLD = 0.95; // ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏°‡∏±‡πà‡∏ô‡πÉ‡∏à 95%
        const SEND_DELAY = 5000; // ‡∏´‡∏ô‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤ 5 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ
        // -----------------------------------------------------------------

        let model, webcam, labelContainer, maxPredictions;
        let isSending = false; 

        // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô (‡πÇ‡∏´‡∏•‡∏î‡πÇ‡∏°‡πÄ‡∏î‡∏•‡πÅ‡∏•‡∏∞‡πÄ‡∏õ‡∏¥‡∏î‡∏Å‡∏•‡πâ‡∏≠‡∏á)
        async function init() {
            const modelURL = URL + "model.json";
            const metadataURL = URL + "metadata.json";

            model = await tmImage.load(modelURL, metadataURL);
            maxPredictions = model.getTotalClasses();

            webcam = new tmImage.Webcam(200, 200, true); 
            await webcam.setup(); 
            await webcam.play();
            window.requestAnimationFrame(loop);

            document.getElementById("webcam-container").appendChild(webcam.canvas);
            labelContainer = document.getElementById("label-container");
            for (let i = 0; i < maxPredictions; i++) {
                labelContainer.appendChild(document.createElement("div"));
            }
        }

        // Loop ‡∏´‡∏•‡∏±‡∏Å ‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏ï‡∏•‡∏≠‡∏î‡πÄ‡∏ß‡∏•‡∏≤
        async function loop() {
            webcam.update(); 
            await predict();
            window.requestAnimationFrame(loop);
        }

        // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ó‡∏≥‡∏ô‡∏≤‡∏¢‡∏ú‡∏•‡∏à‡∏≤‡∏Å‡∏†‡∏≤‡∏û (‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÉ‡∏´‡πâ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ó‡∏±‡πâ‡∏á Class 1 ‡πÅ‡∏•‡∏∞ 2)
        async function predict() {
            const prediction = await model.predict(webcam.canvas);
            for (let i = 0; i < maxPredictions; i++) {
                const classPrediction =
                    prediction[i].className + ": " + prediction[i].probability.toFixed(2);
                labelContainer.childNodes[i].innerHTML = classPrediction;

                // === ‡∏™‡πà‡∏ß‡∏ô‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç: ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÅ‡∏•‡∏∞‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• (‡πÄ‡∏ß‡∏≠‡∏£‡πå‡∏ä‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á) ===
                const className = prediction[i].className;
                const probability = prediction[i].probability;

                if (
                    (className === "Class 1" || className === "Class 2") && // üëà ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ó‡∏±‡πâ‡∏á 2 Class
                    probability > CONFIDENCE_THRESHOLD &&
                    !isSending
                ) {
                    isSending = true; 
                    sendDataToSheet(className); // üëà ‡∏™‡πà‡∏á‡∏ä‡∏∑‡πà‡∏≠ Class ‡∏ó‡∏µ‡πà‡∏ï‡∏£‡∏ß‡∏à‡∏à‡∏±‡∏ö‡πÑ‡∏î‡πâ
                }
            }
        } // üëà üö® ‡∏ô‡∏µ‡πà‡∏Ñ‡∏∑‡∏≠ '}' ‡∏ó‡∏µ‡πà‡∏°‡∏±‡∏Å‡∏à‡∏∞‡∏´‡∏≤‡∏¢‡πÑ‡∏õ

        // === ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• (‡πÄ‡∏ß‡∏≠‡∏£‡πå‡∏ä‡∏±‡∏ô text/plain ‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á) ===
        async function sendDataToSheet(predictionResult) {
            console.log("Sending data to Google Sheet:", predictionResult);
            
            try {
                const response = await fetch(APPS_SCRIPT_URL, {
                    method: 'POST',
                    body: predictionResult, // üëà ‡∏™‡πà‡∏á‡πÄ‡∏õ‡πá‡∏ô text/plain
                    headers: {
                        'Content-Type': 'text/plain' // üëà ‡πÉ‡∏ä‡πâ Content-Type ‡∏ô‡∏µ‡πâ
                    }
                });
                
                const result = await response.json();
                
                if (result.result === "success") {
                    console.log("Data sent successfully!");
                } else {
                    console.error("Error sending data:", result.message);
                }

            } catch (error) {
                console.error("Fetch error:", error);
            }

            setTimeout(() => {
                isSending = false;
                console.log("Ready to send again.");
            }, SEND_DELAY);
        } // üëà üö® ‡∏´‡∏£‡∏∑‡∏≠ '}' ‡∏ï‡∏±‡∏ß‡∏ô‡∏µ‡πâ‡∏ó‡∏µ‡πà‡∏°‡∏±‡∏Å‡∏à‡∏∞‡∏´‡∏≤‡∏¢‡πÑ‡∏õ
    </script>
</body>
</html>
